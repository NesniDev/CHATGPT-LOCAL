---
import Layout from '../layouts/Layout.astro'
import ChatText from './ChatText.astro'
---

<Layout>
  <main
    class="w-96 max-w-full h-[70vh] bg-gray-200 border-2 rounded-lg p-8 shadow-gray-100 shadow-lg mb-8 overflow-y-auto scroll-smooth"
  >
    <ul class="flex flex-col p-0">
      <ChatText who="USER" message="Hola, ¿cómo estás?" />
      <ChatText who="GPT" message="Hola, estoy bien, en qué puedo ayudarte?" />
    </ul>
  </main>
  <form class="flex gap-2">
    <input
      type="text"
      placeholder="Escribe tu mensaje..."
      class="bg-white/10 rounded-lg flex-1 text-white border-2 border-gray-900 p-2 placeholder:text-white"
    />
    <button
      disabled
      class="py-2 px-4 bg-green-500 rounded-lg font-semibold hover:bg-green-500/80 transition cursor-pointer disabled:opacity-35"
      >Enviar</button
    >
  </form>
  <template id="template-message">
    <li class="flex flex-col gap-1 my-1 py-1 px-2">
      <span
        class="sender p-4 size-5 text-[10px] font-bold flex justify-center items-center rounded-full"
      ></span>
      <p class="text-sm rounded-sm px-1"></p>
    </li>
  </template>

  <small class="text-white/70 mt-10 text-sm w-72 mx-auto text-center"
    >&nbsp;Cargando modelo...</small
  >
</Layout>

<script>
  import { CreateWebWorkerMLCEngine, MLCEngine } from '@mlc-ai/web-llm'

  const $form = document.querySelector<HTMLFormElement>('form')!
  const $input = document.querySelector<HTMLInputElement>('input')!
  const $template =
    document.querySelector<HTMLTemplateElement>('#template-message')!
  const $messages = document.querySelector<HTMLUListElement>('ul')!
  const $container = document.querySelector<HTMLDivElement>('main')!
  const $button = document.querySelector<HTMLButtonElement>('button')!
  const $small = document.querySelector<HTMLDivElement>('small')!

  // ---------------------------

  interface Message {
    role: string
    content: string
  }

  let messages: Message[] = []
  const SELECTED_MODEL = 'Hermes-3-Llama-3.2-3B-q4f16_1-MLC'

  // Initialize with a progress callback
  const initProgressCallback = (info: { progress: number; text: any }) => {
    console.log('Model loading progress:', info.progress)
    $small.textContent = `${info.text}`
    if (info.progress === 1) {
      // $small.textContent = 'Modelo cargado correctamente'
      $button.removeAttribute('disabled')
    }
  }

  const worker = new Worker(new URL('../data/worker.ts', import.meta.url), {
    type: 'module'
  })

  // Using CreateMLCEngine
  const engine = await CreateWebWorkerMLCEngine(worker, SELECTED_MODEL, {
    initProgressCallback
  })

  // Direct instantiation
  const engineInstance = new MLCEngine({ initProgressCallback })
  await engineInstance.reload(SELECTED_MODEL)

  // ---------------------------

  $form?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const messageText = $input.value.trim()
    if (messageText !== '') {
      $input.value = ''
    }

    addMessage(messageText, 'USER')

    const userMessage = {
      role: 'user',
      content: messageText
    }

    messages.push(userMessage)

    const chunks = await engine.chat.completions.create({
      //@ts-ignore
      messages,
      stream: true
    })

    let reply = ''
    const textChunk = addMessage('', 'GPT')

    for await (const chunk of chunks) {
      const [choice] = chunk.choices
      const content = choice.delta.content ?? ''
      reply += content
      textChunk.textContent = reply
    }

    messages.push({
      role: 'assistant',
      content: reply
    })
    $container.scrollTop = $container.scrollHeight
  })

  const addMessage = (text: string, sender: 'USER' | 'GPT') => {
    const clonedTemplate = $template.content.cloneNode(true) as DocumentFragment

    const $newMessage = clonedTemplate.querySelector('li')!
    const $who = $newMessage.querySelector('span')!
    const $text = $newMessage.querySelector('p')!

    $text.textContent = text
    $who.textContent = sender

    if (sender === 'GPT') {
      $newMessage.classList.add('self-start', 'items-start')
      $who.classList.add('bg-black', 'text-white')
      $text.classList.add('bg-black/80', 'text-white')
    } else {
      $newMessage.classList.add('self-end', 'items-end')
      $who.classList.add('bg-blue-200')
      $text.classList.add('bg-blue-100/80')
    }

    $messages.appendChild($newMessage)
    $container.scrollTop = $container.scrollHeight

    return $text
  }
</script>
