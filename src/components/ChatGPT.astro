---
import Layout from '../layouts/Layout.astro'
import ChatText from './ChatText.astro'
---

<Layout>
  <main
    class="w-96 max-w-full h-[60vh] bg-gray-200 border-2 rounded-lg p-8 shadow-gray-100 shadow-lg mb-8 overflow-y-auto scroll-smooth"
  >
    <ul class="flex flex-col p-0">
      <ChatText who="GPT" message="Este es el mensaje del bot" />
      <ChatText who="USER" message="Este es el mensaje del usuario" />
      <ChatText
        who="USER"
        message="Esta es la respuesta del usuario y es uuna respuesta larga para ver que no se rompe nada"
      />
    </ul>
  </main>
  <form class="flex gap-2">
    <input
      type="text"
      placeholder="Escribe tu mensaje..."
      class="rounded-lg flex-1 text-white border-2 border-gray-900 p-2 placeholder:text-white"
    />
    <button
      class="py-2 px-4 bg-green-500 rounded-lg font-semibold hover:bg-green-500/80 transition cursor-pointer disabled:opacity-35"
      >Enviar</button
    >
  </form>
  <template id="template-message">
    <li class="flex flex-col gap-1 my-1 py-1 px-2">
      <span
        class="sender p-5 size-8 font-bold flex justify-center items-center rounded-full"
      ></span>
      <p class="text rounded-sm px-1"></p>
    </li>
  </template>
</Layout>

<script>
  const $form = document.querySelector<HTMLFormElement>('form')!
  const $input = document.querySelector<HTMLInputElement>('input')!
  const $template =
    document.querySelector<HTMLTemplateElement>('#template-message')!
  const $messages = document.querySelector<HTMLUListElement>('ul')!
  const $container = document.querySelector<HTMLDivElement>('main')!
  const $button = document.querySelector<HTMLButtonElement>('button')!

  $form?.addEventListener('submit', (e) => {
    e.preventDefault()

    const messageText = $input.value.trim()
    if (messageText !== '') {
      $input.value = ''
    }
    if (messageText === '') return

    addMessage(messageText, 'USER')

    setTimeout(() => {
      addMessage('Este es un mensaje de prueba del bot', 'GPT')
    }, 2000)
  })

  const addMessage = (text: string, sender: 'USER' | 'GPT') => {
    const clonedTemplate = $template.content.cloneNode(true) as DocumentFragment

    const $newMessage = clonedTemplate.querySelector('li')!
    const $who = $newMessage.querySelector('span')!
    const $text = $newMessage.querySelector('p')!

    $text.textContent = text
    $who.textContent = sender

    if (sender === 'GPT') {
      $newMessage.classList.add('self-start', 'items-start')
      $who.classList.add('bg-black', 'text-white')
      $text.classList.add('bg-black/80', 'text-white')
    } else {
      $newMessage.classList.add('self-end', 'items-end')
      $who.classList.add('bg-blue-200')
      $text.classList.add('bg-blue-100/80')
    }

    $messages.appendChild($newMessage)
    $container.scrollTop = $container.scrollHeight
  }
</script>
